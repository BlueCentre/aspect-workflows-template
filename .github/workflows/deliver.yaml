on:
    push:
        branches: [main, push_starters, platform, platform-v2.0]
jobs:
    deliver:
        strategy:
            matrix:
                preset:
                    - cpp
                    - go
                    - java
                    - js
                    - kitchen-sink
                    - kotlin
                    - minimal
                    - py
                    - rust
                    - shell
                    - backstage-cpp
                    - backstage-go
                    - backstage-java
                    - backstage-js
                    - backstage-kitchen-sink
                    - backstage-kotlin
                    - backstage-minimal
                    - backstage-py
                    - backstage-rust
                    - backstage-shell
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v5
            - uses: jaxxstorm/action-install-gh-release@6096f2a2bbfee498ced520b6922ac2c06e990ed2 # v2.1.0
              with:
                repo: hay-kot/scaffold
                tag: v0.11.0
            - name: setting to always run hooks
              if: "${{ matrix.preset != 'minimal' }}"
              run: echo "SCAFFOLD_SETTINGS_RUN_HOOKS=always" >> "$GITHUB_ENV"
            - name: Scaffold new app
              id: scaffold
              run: |
                scaffold new --preset=${{ matrix.preset }} --no-prompt $GITHUB_WORKSPACE
                cd scaffold_test*
                cp $GITHUB_WORKSPACE/user_stories/${{ matrix.preset }}.md README.md
                git init
                git add .
                git config user.email "git@nocentre.net"
                git config user.name "Git, the Delivery bot"
                git commit -a -m "template"
                echo "dir=$PWD" >> $GITHUB_OUTPUT
            - name: Convert preset name to deploy secret name
              id: which-secret
              run: |
                CLEAN="${{ matrix.preset }}"
                CLEAN="${CLEAN//-/_}"       
                echo "secret-name=STARTER_DEPLOY_${CLEAN^^}" >> "$GITHUB_OUTPUT"
            - name: Force-Push to Starter repo
              working-directory: ${{ steps.scaffold.outputs.dir }}
              env:
                SSH_KEY: ${{ secrets[steps.which-secret.outputs.secret-name] }}
                SECRET_NAME: ${{ steps.which-secret.outputs.secret-name }}
              run: |
                if [ -z "$SSH_KEY" ]; then
                  echo "::error::Secret $SECRET_NAME is missing or empty. Please create it in GitHub Settings."
                  exit 1
                fi
                eval $(ssh-agent -s)
                ssh-add - <<< "$SSH_KEY"
                git push  --force git@github.com:BlueCentre/${{ matrix.preset }}.git HEAD:main
