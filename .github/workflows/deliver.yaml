on:
    push:
        branches: [main, push_starters, platform]
jobs:
    deliver:
        strategy:
            matrix:
                preset:
                    - cpp
                    - go
                    - java
                    - js
                    - kitchen-sink
                    - kotlin
                    - minimal
                    - py
                    - rust
                    - shell
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Get branch name
              id: get-branch-name
              run: |
                if [ "${{ github.event_name }}" == "pull_request" ]; then
                  echo "BRANCH_NAME=${{ github.head_ref }}" >> $GITHUB_OUTPUT
                else
                  echo "BRANCH_NAME=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT
                fi
              shell: bash

            - uses: jaxxstorm/action-install-gh-release@6096f2a2bbfee498ced520b6922ac2c06e990ed2 # v2.1.0
              with:
                repo: hay-kot/scaffold
                tag: v0.10.3

            - name: Setting to always run hooks
              if: "${{ matrix.preset != 'minimal' }}"
              run: echo "SCAFFOLD_SETTINGS_RUN_HOOKS=always" >> "$GITHUB_ENV"

            - name: Scaffold new app
              id: scaffold
              run: |
                scaffold new --preset=${{ matrix.preset }} --no-prompt $GITHUB_WORKSPACE
                cd scaffold_test*
                cp $GITHUB_WORKSPACE/user_stories/${{ matrix.preset }}.md README.md
                git init
                git add .
                git config user.email "git@nocentre.net"
                git config user.name "Git, the Delivery bot"
                git commit -a -m "chore: scaffold generated template"
                echo "dir=$PWD" >> $GITHUB_OUTPUT

            # TODO: Switch to GitHub App Token approach (https://github.com/marketplace/actions/create-github-app-token)
            - name: Convert preset name to deploy secret name
              id: which-secret
              run: |
                CLEAN="${{ matrix.preset }}"
                CLEAN="${CLEAN//-/_}"       
                echo "secret-name=STARTER_DEPLOY_${CLEAN^^}" >> "$GITHUB_OUTPUT"

            - name: Force-Push to Starter repo
              working-directory: ${{ steps.scaffold.outputs.dir }}
              run: |
                eval $(ssh-agent -s)
                ssh-add - <<< '${{ secrets[steps.which-secret.outputs.secret-name] }}'
                git push --force git@github.com:BlueCentre/${{ matrix.preset }}.git HEAD:${{ steps.get-branch-name.outputs.BRANCH_NAME }}
